name: "marp_build"

on:
  push:
    branches:
      - main
    paths:
      - "slides/**"
      - "!slides/**/*.pdf"

  workflow_dispatch:
    inputs:
      targets:
        description: 'Target directory name(s) in slides/ (e.g. "topic1" or "topic1 topic2") or "all" to build all.'
        required: true
        default: ""
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# Job: resolve_targets
# Find build targets based on event type:
# [Push Event]
#   └─> Git Diff (changed-files action)
#     └─> src/filter_build_targets.sh
# [Manual Event]
#   └─> src/expand_manual_targets.sh
#     └─> src/filter_build_targets.sh
#
# [Set results]
# Set MARP_BUILD_TARGETS output variable.
# ==============================================================================
# job: build_pdf
# If MARP_BUILD_TARGETS is not empty, build PDFs for the target folders.
# ==============================================================================

jobs:
  resolve_targets:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      targets: ${{ steps.final-output.outputs.MARP_BUILD_TARGETS }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      # [Push Event]
      # Find changed folders under "slides/"
      # e.g. <my-repo>/slides/topic1/main.md -> slides/topic1
      #      ALL_CHANGED_FOLDERS: slides/topic1 slides/topic2 ...
      - name: Get changed folders
        if: github.event_name == 'push'
        id: changes
        uses: tj-actions/changed-files@2d756ea4c53f7f6b397767d8723b3a10a9f35bf2 # v44.0.0
        with:
          dir_names: true
          dir_names_max_depth: 2
          dir_names_exclude_current_dir: true
          files: slides/**
          separator: " "

      - name: Resolve push targets
        if: github.event_name == 'push' && steps.changes.outputs.any_changed == 'true'
        id: resolve-push
        env:
          ALL_CHANGED_FOLDERS: ${{ steps.changes.outputs.all_changed_files }}
        run: |
          echo "All changed folders: $ALL_CHANGED_FOLDERS"
          TARGETS=$(echo "$ALL_CHANGED_FOLDERS" \
            | src/filter_build_targets.sh)
          echo "Filtered targets: $TARGETS"
          echo "targets=$TARGETS" >> "$GITHUB_OUTPUT"

      # [Manual Event]
      - name: Resolve manual targets
        if: github.event_name == 'workflow_dispatch'
        id: resolve-manual
        env:
          MANUAL_INPUT: ${{ github.event.inputs.targets }}
        run: |
          echo "Manual input: $MANUAL_INPUT"
          TARGETS=$(echo "$MANUAL_INPUT" \
            | src/expand_manual_targets.sh \
            | src/filter_build_targets.sh)
          echo "Resolved targets: $TARGETS"
          echo "targets=$TARGETS" >> "$GITHUB_OUTPUT"

      # [Set results]
      - name: Set final targets
        id: final-output
        env:
          PUSH_TARGETS: ${{ steps.resolve-push.outputs.targets }}
          MANUAL_TARGETS: ${{ steps.resolve-manual.outputs.targets }}
        run: |
          echo "Event type: ${{ github.event_name }}"
          case "${{ github.event_name }}" in
            push)
              FINAL_TARGETS="$PUSH_TARGETS"
              ;;
            workflow_dispatch)
              FINAL_TARGETS="$MANUAL_TARGETS"
              ;;
          esac
          echo "Final targets: $FINAL_TARGETS"
          echo "MARP_BUILD_TARGETS=$FINAL_TARGETS" >> "$GITHUB_OUTPUT"

  build_pdf:
    needs: resolve_targets
    if: ${{ needs.resolve_targets.outputs.targets != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install nix
        uses: nixbuild/nix-quick-install-action@2c9db80fb984ceb1bcaa77cdda3fdf8cfba92035 # v34
        with:
          nix_conf: |
            keep-env-derivations = true
            keep-outputs = false

      - name: Setup cache tool
        uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 3G
          purge: true
          purge-prefixes: nix-${{ runner.os }}-
          purge-created: 0
          purge-last-accessed: 0
          purge-primary-key: never

      - name: Build Nix environment
        run: nix develop .#ci -c echo "Environment setup done"

      - name: Build PDFs
        env:
          MARP_BUILD_TARGETS: ${{ needs.resolve_targets.outputs.targets }}
        run: |
          read -ra targets <<< "$MARP_BUILD_TARGETS"
          echo "Building PDFs for targets: ${targets[@]}"
          nix develop .#ci -c task marp -- "${targets[@]}"

      - name: Archive PDFs
        env:
          MARP_BUILD_TARGETS: ${{ needs.resolve_targets.outputs.targets }}
        run: |
          mkdir -p artifact
          for folder in $MARP_BUILD_TARGETS; do
            echo "Archiving $folder/main.pdf"
            mkdir -p "artifact/$folder"
            cp "$folder/main.pdf" "artifact/$folder/"
            echo "Archived: artifact/$folder/main.pdf"
          done

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: built_pdfs
          path: artifact/
          retention-days: 1
          if-no-files-found: error

  deploy:
    needs: [resolve_targets, build_pdf]
    if: needs.build_pdf.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download built PDFs artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: built_pdfs
          path: .

      - name: Setup git config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin "https://github-actions:${GITHUB_TOKEN}@github.com/${{ github.repository }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Push PDFs
        env:
          MARP_BUILD_TARGETS: ${{ needs.resolve_targets.outputs.targets }}
        run: |
          for folder in $MARP_BUILD_TARGETS; do
            echo "Staging $folder/main.pdf"
            git add "$folder/main.pdf"
          done

          if git diff --cached --quiet; then
            echo "::unexpected error::No changes to commit! PDF generation might have failed silently."
            exit 1
          fi

          git commit -m "Build PDFs for updated slides"
          git pull --rebase origin main
          git push origin HEAD:main
          echo "PDFs pushed successfully."
